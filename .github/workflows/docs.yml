---
name: Documentation

on:
  push:
    branches: [main]
    paths:
      - docs/**
      - src/aclaf/**/*.py
      - mkdocs.yml
      - pyproject.toml
      - wrangler.toml
      - justfile
      - package.json
      - pnpm-lock.yaml
      - .markdownlint-cli2.jsonc
      - .vale.ini
      - biome.json
  pull_request:
    branches: [main]
    paths:
      - docs/**
      - src/aclaf/**/*.py
      - mkdocs.yml
      - pyproject.toml
      - wrangler.toml
      - justfile
      - package.json
      - pnpm-lock.yaml
      - .markdownlint-cli2.jsonc
      - .vale.ini
      - biome.json
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Install uv
        uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3 # v7.1.3
        with:
          python-version: "3.12"
          enable-cache: true

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        name: Install pnpm
        with:
          run_install: true

      - name: Install Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 24
          cache: "pnpm"

      - name: Install just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Lint documentation
        run: just lint-docs

  vale:
    name: Vale
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Run Vale
        uses: errata-ai/vale-action@d89dee975228ae261d22c15adcd03578634d429c # v2.1.1
        with:
          version: 3.13.0

  deploy:
    name: Deploy
    needs:
      - lint
      - vale
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3 # v7.1.3
        with:
          python-version: "3.12"
          enable-cache: true

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        name: Install pnpm
        with:
          run_install: true

      - name: Install Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 24
          cache: "pnpm"

      - name: Install just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3

      - name: Deploy documentation
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: just deploy-docs

      - name: Deploy documentation preview
        if: github.event_name == 'pull_request'
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: just deploy-docs-pr ${{ github.event.pull_request.number }}

      - name: Comment PR with preview URL
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PREVIEW_URL="https://pr-${{ github.event.pull_request.number }}-aclaf-docs-pr.tbhb.workers.dev/"
          gh pr comment ${{ github.event.pull_request.number }} --body "ðŸ“š **Documentation preview deployed!**

          Preview URL: ${PREVIEW_URL}

          The preview will be updated automatically with each commit to this PR."
